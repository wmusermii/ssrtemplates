<main class="pt-2 max-w-screen-xl mx-auto px-2 mb-2">
  <!-- Breadcrumb -->
  <div class="w-full flex bg-white py-3 px-5 items-center rounded shadow mb-2">
    <p-breadcrumb [model]="breaditems" [home]="home" />
  </div>
  <!-- Konten utama -->
  <div class="flex h-[60vh] gap-2">
    <!-- Canvas kanan -->
    @if (isReady) {
    <f-flow fDraggable class="flex-1" (fLoaded)="onLoaded()" (fMoveNodes)="onMoveNode($event)">
      <f-canvas>
        <!-- Foblex: aktifkan fitur drag-to-connect -->
        <!-- <f-connection-for-create *ngIf="isConnectionMode"></f-connection-for-create> -->
        <!-- Render semua koneksi -->
        @for (conn of connections; track conn.outputId + '->' + conn.inputId) {
        <f-connection
          [fOutputId]="conn.outputId"
          [fInputId]="conn.inputId"
          [fReassignDisabled]="true"
          fType="segment"
          >
        </f-connection>
        }
        <!-- Render semua node -->
        @for (node of nodes(); track node.id) {
        <div fNode [attr.id]="'f-node-' + node.id" [fNodePosition]="node.position" (click)="nodeClicked(node, $event)"
          (dblclick)="openEditDialog(node)"
          class="f-node cursor-pointer !text-white font-bold !rounded-md whitespace-nowrap px-2 py-1 flex items-center gap-2"
          [ngStyle]="{
            'background-color':
              node.type === 'Start' ? '#3b82f6' :
              node.type === 'Business Task' ? '#6b7280' :
              node.type === 'End' ? '#ef4444' : '#999'
          }">
          <!-- Kiri: Input port untuk Business Task & End -->
          @if (node.type === 'Business Task' || node.type === 'End') {
          <div fNodeInput [fInputId]="'in' + node.id" fInputConnectableSide="left" class="input-port"></div>
          }

          <!-- Ikon drag -->
          <span fDragHandle class="f-icon f-drag-handle-icon">
            <div class="text-lg text-white opacity-70 leading-none select-none">â‹®â‹®</div>
          </span>

          <!-- Label tengah -->
          <span class="flex-1 text-center" style="padding-right: 10px;">{{ node.text }}</span>

          <!-- Kanan: Output port untuk Start & Business Task -->
          @if (node.type === 'Start' || node.type === 'Business Task') {
          <div fNodeOutput [fOutputId]="'out' + node.id" fOutputConnectableSide="right" class="output-port"></div>
          }
        </div>


        }
      </f-canvas>
      <!-- Dialog edit node -->
      <p-dialog [(visible)]="editDialogVisible" [modal]="true" header="Node Detail" [style]="{ width: '450px' }">

        <div class="p-fluid space-y-4">

          <!-- Label -->
          <div>
            <div class="mt-1 text-base font-semibold text-gray-900">
              {{ editNodeText }}
            </div>
          </div>
          <!-- Description -->
          <div>
            <div class="mt-1 text-base border rounded bg-gray-50" [innerHTML]="editNodeDescription">
            </div>
          </div>

        </div>

        <ng-template pTemplate="footer">
          <div class="flex justify-end">
            <button pButton label="OK" icon="pi pi-check" (click)="editDialogVisible = false"></button>
          </div>
        </ng-template>

      </p-dialog>

      <!-- Palet kiri -->
      <div class="external-panel">

        <button pButton label="back" icon="pi pi-back" class="p-button-sm w-full" (click)="toggleBack()" text="true">
        </button>
        <div class="border-t !border-solid border-gray-200 mt-2"></div>
        <!-- Tombol Connection Mode -->
        <!-- Tombol Save -->
        <button pButton label="Save Node" icon="pi pi-save" class="p-button-sm w-full"
          (click)="saveFlowToDatabase()"></button>
      </div>

    </f-flow>
    } @else {
    <div class="flex items-center justify-center w-full text-gray-500">
      ðŸ”„ Memuat canvas...
    </div>
    }
  </div>
</main>

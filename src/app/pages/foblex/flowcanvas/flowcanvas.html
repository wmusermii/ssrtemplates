<main class="pt-2 max-w-screen-xl mx-auto px-2 mb-2">
  <!-- Breadcrumb -->
  <div class="w-full flex bg-white py-2 px-5 items-center rounded shadow mb-2">
    <p-breadcrumb [model]="breaditems" [home]="home" />
  </div>

  <!-- Konten utama -->
  <div class="flex h-[60vh] gap-2">
    <!-- Canvas kanan -->
    @if (isReady) {
    <f-flow fDraggable class="flex-1"
      (fLoaded)="onLoaded()"
      (fCreateNode)="onCreateNode($event)"
      (fMoveNodes)="onMoveNode($event)"
      (fCreateConnection)="onCreateConnection($event)"
      >
      <f-canvas>
        <!-- Foblex: aktifkan fitur drag-to-connect -->
        <f-connection-for-create *ngIf="isConnectionMode"></f-connection-for-create>
        <!-- Render semua koneksi -->
        @for (conn of connections; track conn.outputId + '->' + conn.inputId) {
          <f-connection
            [fOutputId]="conn.outputId"
            [fInputId]="conn.inputId"
            [fReassignDisabled]="true">
          </f-connection>
        }
        <!-- Render semua node -->
        @for (node of nodes(); track node.id) {
        <div fNode [attr.id]="'f-node-' + node.id" [fNodePosition]="node.position" (click)="nodeClicked(node, $event)"
          (dblclick)="openEditDialog(node)"
          class="f-node cursor-pointer !text-white font-bold !rounded-md whitespace-nowrap px-2 py-1 flex items-center gap-2"
          [ngStyle]="{
            'background-color':
              node.type === 'Start' ? '#3b82f6' :
              node.type === 'Business Task' ? '#6b7280' :
              node.type === 'End' ? '#ef4444' : '#999'
          }">
          <!-- Kiri: Input port untuk Business Task & End -->
          @if (node.type === 'Business Task' || node.type === 'End') {
          <div fNodeInput [fInputId]="'in' + node.id" fInputConnectableSide="left" class="input-port"></div>
          }

          <!-- Ikon drag -->
          <span fDragHandle class="f-icon f-drag-handle-icon">
            <div class="text-lg text-white opacity-70 leading-none select-none">â‹®â‹®</div>
          </span>

          <!-- Label tengah -->
          <span class="flex-1 text-center" style="padding-right: 10px;">{{ node.text }}</span>

          <!-- Kanan: Output port untuk Start & Business Task -->
          @if (node.type === 'Start' || node.type === 'Business Task') {
          <div fNodeOutput [fOutputId]="'out' + node.id" fOutputConnectableSide="right" class="output-port"></div>
          }
        </div>


        }
      </f-canvas>
      <!-- Dialog edit node -->
      <p-dialog [(visible)]="editDialogVisible" [modal]="true" header="Edit Node" [style]="{ width: '400px' }"
        (click)="stopFlowEvents($event)" (wheel)="stopFlowEvents($event)">
        <div class="p-fluid space-y-4">
          <div class="flex flex-col gap-1">
            <label for="nodeLabel" class="text-sm font-medium text-gray-700">Label Node</label>
            <input id="nodeLabel" type="text" pInputText class="w-full" placeholder="Masukkan nama node..."
              [(ngModel)]="editNodeText" (click)="stopFlowEvents($event)" (wheel)="stopFlowEvents($event)" />
          </div>
        </div>

        <ng-template pTemplate="footer">
          <div class="flex justify-end gap-2">
            <button pButton label="Cancel" class="p-button-text" (click)="cancelEdit()"></button>
            <button pButton label="Save" icon="pi pi-check" (click)="saveNodeEdit()"
              [disabled]="!editNodeText.trim()"></button>
          </div>
        </ng-template>
      </p-dialog>
      <!-- Palet kiri -->
      <div class="external-panel">
        <div class="external-item" fExternalItem [fData]="'Start'" [fPreviewMatchSize]="isMatchSize()">
          ğŸ”µ Start
        </div>
        <div class="external-item" fExternalItem [fData]="'Business Task'" [fPreviewMatchSize]="isMatchSize()">
          âš™ï¸ Business Task
        </div>
        <div class="external-item" fExternalItem [fData]="'End'" [fPreviewMatchSize]="isMatchSize()">
          ğŸ”´ End
        </div>
        <button pButton [label]="isConnectionMode ? 'Nodes' : 'Connections'"
          [icon]="isConnectionMode ? 'pi pi-ban' : 'pi pi-share-alt'" class="p-button-sm w-full"
          [class.p-button-outlined]="isConnectionMode" (click)="toggleConnectionMode()">
        </button>
        <div class="py-3 border-t border-gray-200 mt-2"></div>

        <!-- Tombol Connection Mode -->


        <!-- Tombol Save -->
        <button pButton label="Save Node" icon="pi pi-save" class="p-button-sm w-full"
          (click)="saveFlowToDatabase()"></button>
      </div>

    </f-flow>
    } @else {
    <div class="flex items-center justify-center w-full text-gray-500">
      ğŸ”„ Memuat canvas...
    </div>
    }
  </div>

  <!-- Log aktivitas -->
  <section class="bg-white border rounded shadow !h-40 flex flex-col p-0">
    <h3 class="text-lg font-semibold flex-shrink-0 mb-1 px-2">ğŸ§¾ Log Aktivitas</h3>
    <div class="flex-1 overflow-y-auto flex min-h-0 max-h-full px-2">
      <ul #logContainer class="text-sm text-gray-700 space-y-1 flex flex-col-reverse">
        <li *ngFor="let log of logs">{{ log }}</li>
      </ul>
    </div>
  </section>





</main>
